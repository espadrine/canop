<!doctype html><meta charset=utf-8>
<title> Convergent Collaborative Editing </title>
<link rel=stylesheet href=cm-3.16/lib/codemirror.css>
<body>
<script src=cm-3.16/lib/codemirror.js></script>
<script src=canop.js>/* Collaborative library */</script>
<script>

var Client = canop.Client;
var Operation = canop.Operation;

var editor = CodeMirror(document.body);
var shared = new Client();
var operation = new Operation();//

function editorChange(editor, change) {
  var from = change.from;
  var to = change.to;
  var text = change.text.join('\n');
  var removed = change.removed.join('\n');
  if (removed.length > 0) {
    shared.delete(editor.indexFromPos(from), removed);
  }
  if (text.length > 0) {
    shared.insert(editor.indexFromPos(from), text);
  }
  if (change.next) { editorChange(editor, change.next);
  } else {
    send();
  }
}

// Connection.

var socket = new WebSocket(
    // Trick: use the end of either http: or https:.
    'ws' + window.location.protocol.slice(4) + '//' +
      window.location.hostname +
      (window.location.port.length > 0? (':' + window.location.port): '') +
      '/$websocket:text');

function send() {
  if (shared.local.list.length > 0) {
    shared.prepareSent();
    console.log('> ' + JSON.stringify({ D: shared.sent.list }));
    socket.send(JSON.stringify({ D: shared.sent.list }));
  }
}

socket.onmessage = function recv(event) {
  var update = JSON.parse(event.data);
  console.log('< ' + JSON.stringify(update));
  if (update.M !== undefined) {
    editor.off('change', editorChange);
    editor.setValue(update.M);
    shared.reset(update.M, update.B);
    editor.on('change', editorChange);
  } else if (update.D !== undefined) {
    var change = Operation.fromList(update.D);
    shared.receiveCanon(change);
    updateEditor(editor, change);
  }
};

function updateEditor(editor, delta) {
  editor.off('change', editorChange);
  var cursor = editor.getCursor();
  editor.setValue(''+shared);
  editor.setCursor(cursor);
  // Smarter method:
  //var editorDelta = editorChanges(delta);
  //applyDelta(editorDelta);
  editor.on('change', editorChange);
}

function inverseOperation(operation) {
  var inverse = operation.dup();
  // Insertions become deletions and vice-versa.
  for (var i = 0; i < inverse.list.length; i++) {
    inverse.list[i].tag = inverse.list[i].tag === tags.insert? tags.delete:
        tags.insert;
  }
  return inverse;
};

function applyDelta(delta) {
  for (var i = 0; i < change.list.length; i++) {
    if (change.list[i].tag === tags.insert) {
      //TODO
    } else if (change.list[i].tag === tags.insert) {
      //TODO
    }
  }
}

</script>
</body>
